<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="BikeHistory.Mobile.Views.Bikes.MaintenanceHistoryPage"
             xmlns:viewmodel="clr-namespace:BikeHistory.Mobile.ViewModels"
             xmlns:model="clr-namespace:BikeHistory.Mobile.Models"
             x:DataType="viewmodel:MaintenanceHistoryViewModel"
             Title="정비 이력"
             BackgroundColor="{StaticResource Gray100}">

    <Grid RowDefinitions="*,Auto" 
          Padding="16">

        <!-- Loading Indicator -->
        <Frame Grid.Row="0"
               IsVisible="{Binding IsLoading}"
               BackgroundColor="White"
               CornerRadius="12"
               HasShadow="True"
               Padding="40"
               VerticalOptions="Center"
               HorizontalOptions="Center">
            <StackLayout Orientation="Horizontal" Spacing="16">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                 Color="{StaticResource Primary}"
                                 Scale="1.2" />
                <Label Text="정비 이력 로딩 중..."
                       VerticalOptions="Center"
                       FontSize="16"
                       TextColor="{StaticResource Gray600}" />
            </StackLayout>
        </Frame>

        <!-- Error Message -->
        <Frame Grid.Row="0"
               IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
               BackgroundColor="#FFEBEE"
               BorderColor="#F44336"
               CornerRadius="12"
               Margin="16"
               Padding="20"
               VerticalOptions="Center"
               HorizontalOptions="FillAndExpand">
            <StackLayout Orientation="Horizontal" Spacing="16">
                <Frame BackgroundColor="#F44336"
                       CornerRadius="20"
                       HeightRequest="40"
                       WidthRequest="40"
                       HasShadow="False"
                       Padding="0">
                    <Label FontFamily="FontAwesome"
                           Text="&#xf071;"
                           FontSize="18"
                           TextColor="White"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                </Frame>
                <Label Text="{Binding ErrorMessage}"
                       TextColor="#C62828"
                       VerticalOptions="Center"
                       HorizontalOptions="FillAndExpand"
                       LineBreakMode="WordWrap"
                       FontSize="16" />
            </StackLayout>
        </Frame>

        <!-- Content -->
        <ScrollView Grid.Row="0"
                   IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <VerticalStackLayout Spacing="16">
                
                <!-- Header Card -->
                <Frame BackgroundColor="White"
                       CornerRadius="16"
                       HasShadow="True"
                       Padding="24"
                       Margin="0,8">
                    <StackLayout Orientation="Horizontal" Spacing="16">
                        <Frame BackgroundColor="{StaticResource Warning}"
                               CornerRadius="30"
                               HeightRequest="60"
                               WidthRequest="60"
                               HasShadow="False"
                               Padding="0">
                            <Label HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   FontFamily="FontAwesome"
                                   Text="&#xf0ad;"
                                   FontSize="24"
                                   TextColor="White" />
                        </Frame>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="FillAndExpand">
                            <Label Text="정비 이력"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}" />
                            <Label FontSize="16" TextColor="{StaticResource Gray600}">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding BikeInfo.Manufacturer.Name}" />
                                        <Span Text=" " />
                                        <Span Text="{Binding BikeInfo.Model}" />
                                        <Span Text=" 정비 및 수리 내역" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </VerticalStackLayout>
                    </StackLayout>
                </Frame>

                <!-- History List -->
                <CollectionView ItemsSource="{Binding MaintenanceHistory}"
                              SelectionMode="None">
                    <CollectionView.EmptyView>
                        <Frame BackgroundColor="White"
                               CornerRadius="16"
                               HasShadow="True"
                               Padding="40">
                            <StackLayout Spacing="16">
                                <Frame BackgroundColor="{StaticResource Gray200}"
                                       CornerRadius="30"
                                       HeightRequest="60"
                                       WidthRequest="60"
                                       HasShadow="False"
                                       HorizontalOptions="Center"
                                       Padding="0">
                                    <Label HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           FontFamily="FontAwesome"
                                           Text="&#xf05a;"
                                           FontSize="24"
                                           TextColor="{StaticResource Gray400}" />
                                </Frame>
                                <Label Text="정비 이력이 없습니다"
                                       HorizontalOptions="Center"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Gray600}" />
                                <Label Text="이 자전거는 아직 정비 및 수리 이력이 없습니다"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"
                                       FontSize="14"
                                       TextColor="{StaticResource Gray500}" />
                            </StackLayout>
                        </Frame>
                    </CollectionView.EmptyView>
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:Maintenance">
                            <Frame BackgroundColor="White"
                                   CornerRadius="16"
                                   HasShadow="True"
                                   Margin="0,4"
                                   Padding="24">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:MaintenanceHistoryViewModel}}, Path=ViewMaintenanceDetailCommand}"
                                        CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>
                                
                                <Grid RowDefinitions="Auto,Auto,Auto" 
                                      ColumnDefinitions="Auto,*,Auto">
                                    
                                    <!-- Maintenance Icon with Timeline -->
                                    <StackLayout Grid.Row="0" 
                                               Grid.RowSpan="3"
                                               Grid.Column="0"
                                               Spacing="0"
                                               Margin="0,0,20,0">
                                        <Frame BackgroundColor="{StaticResource Warning}"
                                               CornerRadius="24"
                                               HeightRequest="48"
                                               WidthRequest="48"
                                               HasShadow="False"
                                               Padding="0">
                                            <Label HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   FontFamily="FontAwesome"
                                                   Text="&#xf0ad;"
                                                   FontSize="20"
                                                   TextColor="White" />
                                        </Frame>
                                        <!-- Timeline line -->
                                        <BoxView BackgroundColor="{StaticResource Gray300}"
                                               WidthRequest="2"
                                               HeightRequest="40"
                                               HorizontalOptions="Center"
                                               Margin="0,8,0,0" />
                                    </StackLayout>
                                    
                                    <!-- Maintenance Date -->
                                    <Label Grid.Row="0" 
                                           Grid.Column="1"
                                           Text="{Binding MaintenanceDate, StringFormat='{0:yyyy년 MM월 dd일 HH시 mm분}'}"
                                           FontAttributes="Bold"
                                           FontSize="18"
                                           TextColor="{StaticResource Gray900}" />   

                                    <!-- Maintenance Details -->
                                    <VerticalStackLayout Grid.Row="1" 
                                                       Grid.Column="1"
                                                       Spacing="8"
                                                       Margin="0,12,0,0">
                                        <Frame BackgroundColor="{StaticResource Gray50}"
                                               BorderColor="{StaticResource Gray200}"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               Padding="12">
                                            <StackLayout Orientation="Horizontal" Spacing="8">
                                                <Label FontFamily="FontAwesome"
                                                       Text="&#xf015;"
                                                       FontSize="14"
                                                       TextColor="{StaticResource Primary}"
                                                       VerticalOptions="Center" />
                                                <Label FontSize="14" TextColor="{StaticResource Gray700}" VerticalOptions="Center">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="정비샵: " />
                                                            <Span Text="{Binding StoreName}" FontAttributes="Bold" />
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                            </StackLayout>
                                        </Frame>

                                        <Frame BackgroundColor="{StaticResource Gray50}"
                                               BorderColor="{StaticResource Gray200}"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               Padding="12">
                                            <StackLayout Orientation="Horizontal" Spacing="8">
                                                <Label FontFamily="FontAwesome"
                                                       Text="&#xf02c;"
                                                       FontSize="14"
                                                       TextColor="{StaticResource Info}"
                                                       VerticalOptions="Center" />
                                                <Label FontSize="14" TextColor="{StaticResource Gray700}" VerticalOptions="Center">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="정비 유형: " />
                                                            <Span Text="{Binding MaintenanceTypeName}" FontAttributes="Bold" />
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                            </StackLayout>
                                        </Frame>
                                    </VerticalStackLayout>

                                    <!-- Notes -->
                                    <Frame Grid.Row="2" 
                                           Grid.Column="1"
                                           IsVisible="{Binding Notes, Converter={StaticResource StringToBoolConverter}}"
                                           BackgroundColor="{StaticResource Info}"
                                           BorderColor="Transparent"
                                           CornerRadius="8"
                                           HasShadow="False"
                                           Padding="12"
                                           Margin="0,12,0,0">
                                        <StackLayout Orientation="Horizontal" Spacing="8">
                                            <Label FontFamily="FontAwesome"
                                                   Text="&#xf249;"
                                                   FontSize="14"
                                                   TextColor="White"
                                                   VerticalOptions="Start" />
                                            <Label Text="{Binding Notes}"
                                                   TextColor="White"
                                                   FontSize="14"
                                                   LineBreakMode="WordWrap"
                                                   HorizontalOptions="FillAndExpand" />
                                        </StackLayout>
                                    </Frame>

                                    <!-- Arrow Icon with Click Indicator -->
                                    <Frame Grid.Row="0" 
                                           Grid.RowSpan="3"
                                           Grid.Column="2"
                                           BackgroundColor="{StaticResource Primary}"
                                           CornerRadius="20"
                                           HeightRequest="40"
                                           WidthRequest="40"
                                           HasShadow="False"
                                           Padding="0"
                                           VerticalOptions="Center"
                                           HorizontalOptions="Center">
                                        <Label FontFamily="FontAwesome"
                                               Text="&#xf054;"
                                               FontSize="16"
                                               TextColor="White"
                                               VerticalOptions="Center"
                                               HorizontalOptions="Center" />
                                    </Frame>        
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Back Button -->
        <Button Grid.Row="1"
                Text="뒤로"
                Command="{Binding GoBackCommand}"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                FontAttributes="Bold"
                CornerRadius="12"
                HeightRequest="48"
                Margin="0,16,0,0">
            <Button.ImageSource>
                <FontImageSource FontFamily="FontAwesome" 
                    Glyph="&#xf060;" 
                    Size="16" 
                    Color="White" />
            </Button.ImageSource>
        </Button>
    </Grid>
</ContentPage>