<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="BikeHistory.Mobile.Views.Bikes.BikeListPage"
             xmlns:viewmodel="clr-namespace:BikeHistory.Mobile.ViewModels"
             xmlns:model="clr-namespace:BikeHistory.Mobile.Models"
             x:DataType="viewmodel:BikeListViewModel"
             Title="내 자전거 목록">

    <ContentPage.ToolbarItems>
        <!--<ToolbarItem Text="추가" 
                     Command="{Binding AddNewBikeCommand}" 
                     IconImageSource="plus.png" />
        <ToolbarItem Text="로그아웃" 
                     Command="{Binding LogoutCommand}" 
                     IconImageSource="logout.png" />-->
        <ToolbarItem Text="추가" Command="{Binding AddNewBikeCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="FontAwesome" 
                    Glyph="&#xf067;" 
                    Size="16" 
                    Color="{StaticResource Secondary}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
        <ToolbarItem Text="로그아웃" Command="{Binding LogoutCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="FontAwesome" 
                    Glyph="&#xf2f5;" 
                    Size="16" 
                    Color="{StaticResource Secondary}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="*,Auto" 
          Padding="10">
        
        <RefreshView Grid.Row="0"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">
            
            <CollectionView ItemsSource="{Binding Bikes}"
                          SelectionMode="None">
                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center" 
                               HorizontalOptions="Center"
                               Padding="20">
                        <Image Source="empty_list.png" 
                             HeightRequest="120" 
                             Opacity="0.6" 
                             HorizontalOptions="Center" />
                        <Label Text="자전거가 없습니다"
                             FontSize="18" 
                             HorizontalOptions="Center"
                             Margin="0,20,0,0" />
                        <Label Text="새 자전거를 등록해보세요"
                             FontSize="14" 
                             HorizontalOptions="Center"
                             TextColor="Gray" />
                        <Button Text="자전거 등록하기"
                              Command="{Binding AddNewBikeCommand}"
                              HorizontalOptions="Center"
                              Margin="0,20,0,0" />
                    </StackLayout>
                </CollectionView.EmptyView>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:BikeFrame">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="상세보기"
                                             BackgroundColor="DeepSkyBlue"
                                             Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:BikeListViewModel}}, Path=BikeSelectedCommand}"
                                             CommandParameter="{Binding .}" />
                                </SwipeItems>
                            </SwipeView.RightItems>
                            
                            <Frame Margin="0,5"
                                 Padding="15"
                                 BorderColor="LightGray">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:BikeListViewModel}}, Path=BikeSelectedCommand}"
                                        CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>
                                
                                <Grid ColumnDefinitions="*, Auto">
                                    <VerticalStackLayout Grid.Column="0"
                                                       Spacing="5">
                                        <Label FontSize="18" FontAttributes="Bold">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding Manufacturer.Name}" />
                                                    <Span Text=" " />
                                                    <Span Text="{Binding Model}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        <Label>
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding FrameNumber}" />
                                                    <Span Text=" " />
                                                    <Span Text="{Binding Brand.Name}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        
                                        <Label>
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding BikeType.Name}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        
                                        <Label Text="{Binding RegisteredDate, StringFormat='{0:yyyy년 MM월 dd일 등록}'}"
                                             FontSize="12"
                                             TextColor="Gray" />
                                    </VerticalStackLayout>
                                    
                                    <Image Grid.Column="1"
                                         Source="bike.png"
                                         HeightRequest="50"
                                         WidthRequest="50"
                                         VerticalOptions="Center" />
                                </Grid>
                            </Frame>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
        
        <ActivityIndicator Grid.Row="0"
                          IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          VerticalOptions="Center"
                          HorizontalOptions="Center" />
        
        <Label Grid.Row="0"
             Text="{Binding ErrorMessage}"
             TextColor="Red"
             IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
             VerticalOptions="Center"
             HorizontalOptions="Center" />
        
        <Button Grid.Row="1"
              Text="자전거 등록하기"
              Command="{Binding AddNewBikeCommand}"
              Margin="0,10,0,0" />
    </Grid>
</ContentPage>