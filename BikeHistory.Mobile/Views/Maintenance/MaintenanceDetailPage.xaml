<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="BikeHistory.Mobile.Views.Maintenance.MaintenanceDetailPage"
             xmlns:viewmodel="clr-namespace:BikeHistory.Mobile.ViewModels"
             xmlns:model="clr-namespace:BikeHistory.Mobile.Models"
             x:DataType="viewmodel:MaintenanceDetailViewModel"
             Title="유지보수 상세정보">

	<Grid RowDefinitions="Auto,*,Auto"
          Padding="20">

		<Grid.Resources>
			<Style TargetType="Label" x:Key="FieldLabel">
				<Setter Property="FontSize" Value="14" />
				<Setter Property="TextColor" Value="Gray" />
				<Setter Property="Margin" Value="0,15,0,0" />
			</Style>

			<Style TargetType="Label" x:Key="FieldValue">
				<Setter Property="FontSize" Value="16" />
				<Setter Property="FontAttributes" Value="Bold" />
				<Setter Property="Margin" Value="0,5,0,0" />
			</Style>
		</Grid.Resources>

		<ActivityIndicator Grid.Row="0"
                         IsRunning="{Binding IsBusy}"
                         IsVisible="{Binding IsBusy}"
                         VerticalOptions="Center"
                         HorizontalOptions="Center" />

		<Label Grid.Row="0"
             Text="{Binding ErrorMessage}"
             TextColor="Red"
             IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
             VerticalOptions="Center"
             HorizontalOptions="Center" />

		<ScrollView Grid.Row="1"
                   IsVisible="{Binding Maintenance, Converter={StaticResource ObjectToBoolConverter}}">
			<VerticalStackLayout>
				<!-- 유지보수 기본 정보 섹션 -->
				<Frame BorderColor="LightGray"
                      Margin="0,10,0,20"
                      Padding="15">
					<Grid RowDefinitions="Auto,Auto,Auto,Auto"
                         ColumnDefinitions="*,*">
						<Image Grid.Row="0"
                             Grid.Column="1"
                             Source="tools.png"
                             HeightRequest="80"
                             WidthRequest="80"
                             HorizontalOptions="End"
                             VerticalOptions="Start" />

						<VerticalStackLayout Grid.Row="0"
                                          Grid.Column="0">
							<Label Text="유지보수 일자"
                                 Style="{StaticResource FieldLabel}" />
							<Label Text="{Binding Maintenance.MaintenanceDate, StringFormat='{0:yyyy년 MM월 dd일}'}"
                                 Style="{StaticResource FieldValue}" />
						</VerticalStackLayout>

						<VerticalStackLayout Grid.Row="1"
                                          Grid.Column="0">
							<Label Text="유지보수 유형"
                                 Style="{StaticResource FieldLabel}" />
							<Label Text="{Binding Maintenance.MaintenanceTypeName}"
                                 Style="{StaticResource FieldValue}" />
						</VerticalStackLayout>

						<VerticalStackLayout Grid.Row="1"
                                          Grid.Column="1">
							<Label Text="정비샵"
                                 Style="{StaticResource FieldLabel}" />
							<Label Text="{Binding Maintenance.StoreName}"
                                 Style="{StaticResource FieldValue}" />
						</VerticalStackLayout>

						<VerticalStackLayout Grid.Row="2"
                                          Grid.Column="0">
							<Label Text="결제 방법"
                                 Style="{StaticResource FieldLabel}" />
							<Label Text="{Binding Maintenance.PaymentMethodName}"
                                 Style="{StaticResource FieldValue}" />
						</VerticalStackLayout>

						<VerticalStackLayout Grid.Row="2"
                                          Grid.Column="1">
							<Label Text="총 금액"
                                 Style="{StaticResource FieldLabel}" />
							<Label Text="{Binding Maintenance.FormattedTotalAmount}"
                                 Style="{StaticResource FieldValue}" />
						</VerticalStackLayout>

						<VerticalStackLayout Grid.Row="3"
                                          Grid.ColumnSpan="2">
							<Label Text="비고"
                                 Style="{StaticResource FieldLabel}" />
							<Label Text="{Binding Maintenance.Notes}"
                                 Style="{StaticResource FieldValue}"
                                 IsVisible="{Binding Maintenance.Notes, Converter={StaticResource StringToBoolConverter}}"/>
							<Label Text="없음"
                                 TextColor="Gray"
                                 IsVisible="{Binding Maintenance.Notes, Converter={StaticResource InverseStringToBoolConverter}}"/>
						</VerticalStackLayout>
					</Grid>
				</Frame>

				<!-- 유지보수 상세 항목 섹션 -->
				<Label Text="유지보수 상세 내역"
                     FontSize="18"
                     FontAttributes="Bold"
                     Margin="0,10,0,10" />

				<CollectionView ItemsSource="{Binding Maintenance.MaintenanceDetails}"
                              HeightRequest="300"
                              SelectionMode="None">
					<CollectionView.EmptyView>
						<Label Text="상세 내역이 없습니다"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"
                             TextColor="Gray" />
					</CollectionView.EmptyView>

					<CollectionView.ItemTemplate>
						<DataTemplate x:DataType="model:MaintenanceDetail">
							<Frame Margin="0,5"
                                 Padding="10"
                                 BorderColor="LightGray">
								<Grid RowDefinitions="Auto,Auto,Auto,Auto"
                                    ColumnDefinitions="Auto,*,Auto">
									<Label Grid.Row="0"
                                         Grid.Column="0"
                                         Text="{Binding Seq, StringFormat='#{0}'}"
                                         FontAttributes="Bold"
                                         VerticalOptions="Center"
                                         Margin="0,0,10,0" />

									<Label Grid.Row="0"
                                         Grid.Column="1"
                                         Text="{Binding PartName}"
                                         FontAttributes="Bold"
                                         VerticalOptions="Center" />

									<Label Grid.Row="1"
                                         Grid.Column="1"
                                         Text="{Binding PartSpecification}"
                                         TextColor="Gray"
                                         FontSize="14"
                                         Margin="0,5,0,5"
                                         IsVisible="{Binding PartSpecification, Converter={StaticResource StringToBoolConverter}}" />

									<VerticalStackLayout Grid.Row="2"
                                                      Grid.Column="1">
										<Label Text="{Binding LaborCost, StringFormat='공임비: {0:N0}원'}"
                                             Margin="0,5,0,0" />

										<Label Text="{Binding PartPrice, StringFormat='부품비: {0:N0}원'}"
                                             Margin="0,5,0,0" />
									</VerticalStackLayout>

									<Label Grid.Row="3"
                                         Grid.Column="1"
                                         Text="{Binding TotalCost, StringFormat='소계: {0:N0}원'}"
                                         FontAttributes="Bold"
                                         Margin="0,10,0,0" />
								</Grid>
							</Frame>
						</DataTemplate>
					</CollectionView.ItemTemplate>
				</CollectionView>
			</VerticalStackLayout>
		</ScrollView>

		<Button Grid.Row="2"
              Text="뒤로"
              Command="{Binding GoBackCommand}"
              Margin="0,20,0,0" />
	</Grid>
</ContentPage>