<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="BikeHistory.Mobile.Views.Auth.ProfilePage"
             xmlns:viewmodel="clr-namespace:BikeHistory.Mobile.ViewModels"
             x:DataType="viewmodel:ProfileViewModel"
             Title="내 프로필"
             BackgroundColor="{StaticResource Gray100}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="로그아웃" Command="{Binding LogoutCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="FontAwesome" 
                                Glyph="&#xf2f5;" 
                                Size="18" 
                                Color="{StaticResource Primary}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="*,Auto" 
          Padding="16">

        <!-- Loading Indicator -->
        <Frame Grid.Row="0"
               IsVisible="{Binding IsLoading}"
               BackgroundColor="White"
               CornerRadius="12"
               HasShadow="True"
               Padding="40"
               VerticalOptions="Center"
               HorizontalOptions="Center">
            <StackLayout Orientation="Horizontal" Spacing="16">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                 Color="{StaticResource Primary}"
                                 Scale="1.2" />
                <Label Text="프로필 로딩 중..."
                       VerticalOptions="Center"
                       FontSize="16"
                       TextColor="{StaticResource Gray600}" />
            </StackLayout>
        </Frame>

        <ScrollView Grid.Row="0"
                   IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}">
            <VerticalStackLayout Spacing="16">
                
                <!-- Profile Header Card -->
                <Frame BackgroundColor="White"
                       CornerRadius="16"
                       HasShadow="True"
                       Padding="32"
                       Margin="0,8">
                    <VerticalStackLayout Spacing="16" HorizontalOptions="Center">
                        <!-- Profile Avatar -->
                        <Frame BackgroundColor="{StaticResource Primary}"
                               CornerRadius="60"
                               HeightRequest="120"
                               WidthRequest="120"
                               HasShadow="True"
                               Padding="0"
                               HorizontalOptions="Center">
                            <Label HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   FontFamily="FontAwesome"
                                   Text="&#xf007;"
                                   FontSize="48"
                                   TextColor="White" />
                        </Frame>
                        
                        <!-- User Info -->
                        <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                            <Label FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}"
                                   HorizontalOptions="Center">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding FirstName}" />
                                        <Span Text=" " />
                                        <Span Text="{Binding LastName}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            
                            <StackLayout Orientation="Horizontal" Spacing="8" HorizontalOptions="Center">
                                <Label FontFamily="FontAwesome"
                                       Text="&#xf0e0;"
                                       FontSize="14"
                                       TextColor="{StaticResource Gray400}"
                                       VerticalOptions="Center" />
                                <Label Text="{Binding Email}"
                                       FontSize="16"
                                       TextColor="{StaticResource Gray600}"
                                       VerticalOptions="Center" />
                            </StackLayout>
                            
                            <!-- Role Badges -->
                            <StackLayout Orientation="Horizontal" 
                                       Spacing="8" 
                                       HorizontalOptions="Center"
                                       Margin="0,8,0,0">
                                <Label FontFamily="FontAwesome"
                                       Text="&#xf505;"
                                       FontSize="14"
                                       TextColor="{StaticResource Gray400}"
                                       VerticalOptions="Center" />
                                <CollectionView ItemsSource="{Binding Roles}"
                                              HeightRequest="32"
                                              HorizontalOptions="Center">
                                    <CollectionView.ItemsLayout>
                                        <LinearItemsLayout Orientation="Horizontal"
                                                         ItemSpacing="8" />
                                    </CollectionView.ItemsLayout>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame BackgroundColor="{StaticResource Primary}"
                                                   CornerRadius="16"
                                                   Padding="12,6"
                                                   HasShadow="False"
                                                   Margin="0">
                                                <Label Text="{Binding}"
                                                       TextColor="White"
                                                       FontSize="12"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center" />
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </StackLayout>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- Basic Information Card -->
                <Frame BackgroundColor="White"
                       CornerRadius="16"
                       HasShadow="True"
                       Padding="24">
                    <VerticalStackLayout Spacing="20">
                        <!-- Header -->
                        <StackLayout Orientation="Horizontal" Spacing="12">
                            <Frame BackgroundColor="{StaticResource Info}"
                                   CornerRadius="24"
                                   HeightRequest="48"
                                   WidthRequest="48"
                                   HasShadow="False"
                                   Padding="0">
                                <Label HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       FontFamily="FontAwesome"
                                       Text="&#xf2bb;"
                                       FontSize="20"
                                       TextColor="White" />
                            </Frame>
                            <VerticalStackLayout VerticalOptions="Center">
                                <Label Text="기본 정보"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Gray900}" />
                                <Label Text="개인 정보 수정"
                                       FontSize="14"
                                       TextColor="{StaticResource Gray500}" />
                            </VerticalStackLayout>
                        </StackLayout>
                        
                        <!-- Form Fields -->
                        <VerticalStackLayout Spacing="16">
                            <!-- First Name -->
                            <VerticalStackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label FontFamily="FontAwesome"
                                           Text="&#xf007;"
                                           FontSize="14"
                                           TextColor="{StaticResource Primary}"
                                           VerticalOptions="Center" />
                                    <Label Text="이름"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Gray700}"
                                           VerticalOptions="Center" />
                                </StackLayout>
                                <Frame BackgroundColor="{StaticResource Gray50}"
                                       BorderColor="{StaticResource Gray200}"
                                       CornerRadius="12"
                                       HasShadow="False"
                                       Padding="0">
                                    <Entry Text="{Binding FirstName}"
                                           Placeholder="이름을 입력하세요"
                                           FontSize="16"
                                           Margin="16,12" />
                                </Frame>
                            </VerticalStackLayout>

                            <!-- Last Name -->
                            <VerticalStackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label FontFamily="FontAwesome"
                                           Text="&#xf007;"
                                           FontSize="14"
                                           TextColor="{StaticResource Primary}"
                                           VerticalOptions="Center" />
                                    <Label Text="성"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Gray700}"
                                           VerticalOptions="Center" />
                                </StackLayout>
                                <Frame BackgroundColor="{StaticResource Gray50}"
                                       BorderColor="{StaticResource Gray200}"
                                       CornerRadius="12"
                                       HasShadow="False"
                                       Padding="0">
                                    <Entry Text="{Binding LastName}"
                                           Placeholder="성을 입력하세요"
                                           FontSize="16"
                                           Margin="16,12" />
                                </Frame>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- Password Change Card -->
                <Frame BackgroundColor="White"
                       CornerRadius="16"
                       HasShadow="True"
                       Padding="24">
                    <VerticalStackLayout Spacing="20">
                        <!-- Header -->
                        <StackLayout Orientation="Horizontal" Spacing="12">
                            <Frame BackgroundColor="{StaticResource Warning}"
                                   CornerRadius="24"
                                   HeightRequest="48"
                                   WidthRequest="48"
                                   HasShadow="False"
                                   Padding="0">
                                <Label HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       FontFamily="FontAwesome"
                                       Text="&#xf023;"
                                       FontSize="20"
                                       TextColor="White" />
                            </Frame>
                            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="FillAndExpand">
                                <Label Text="보안 설정"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Gray900}" />
                                <Label Text="비밀번호 변경 및 보안 관리"
                                       FontSize="14"
                                       TextColor="{StaticResource Gray500}" />
                            </VerticalStackLayout>
                            
                            <!-- Toggle Button -->
                            <Frame BackgroundColor="{StaticResource Gray100}"
                                   CornerRadius="20"
                                   HasShadow="False"
                                   Padding="0"
                                   HeightRequest="40"
                                   WidthRequest="40">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding TogglePasswordChangeCommand}" />
                                </Frame.GestureRecognizers>
                                <Label HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       FontFamily="FontAwesome"
                                       Text="{Binding IsPasswordChangeVisible, Converter={StaticResource BoolToExpandCollapseIconConverter}}"
                                       FontSize="16"
                                       TextColor="{StaticResource Gray600}" />
                            </Frame>
                        </StackLayout>
                        
                        <!-- Password Change Form -->
                        <VerticalStackLayout Spacing="16" IsVisible="{Binding IsPasswordChangeVisible}">
                            <!-- Current Password -->
                            <VerticalStackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label FontFamily="FontAwesome"
                                           Text="&#xf023;"
                                           FontSize="14"
                                           TextColor="{StaticResource Warning}"
                                           VerticalOptions="Center" />
                                    <Label Text="현재 비밀번호"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Gray700}"
                                           VerticalOptions="Center" />
                                </StackLayout>
                                <Frame BackgroundColor="{StaticResource Gray50}"
                                       BorderColor="{StaticResource Gray200}"
                                       CornerRadius="12"
                                       HasShadow="False"
                                       Padding="0">
                                    <Entry Text="{Binding CurrentPassword}"
                                           Placeholder="현재 비밀번호를 입력하세요"
                                           IsPassword="True"
                                           FontSize="16"
                                           Margin="16,12" />
                                </Frame>
                            </VerticalStackLayout>

                            <!-- New Password -->
                            <VerticalStackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label FontFamily="FontAwesome"
                                           Text="&#xf084;"
                                           FontSize="14"
                                           TextColor="{StaticResource Success}"
                                           VerticalOptions="Center" />
                                    <Label Text="새 비밀번호"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Gray700}"
                                           VerticalOptions="Center" />
                                </StackLayout>
                                <Frame BackgroundColor="{StaticResource Gray50}"
                                       BorderColor="{StaticResource Gray200}"
                                       CornerRadius="12"
                                       HasShadow="False"
                                       Padding="0">
                                    <Entry Text="{Binding NewPassword}"
                                           Placeholder="새 비밀번호를 입력하세요"
                                           IsPassword="True"
                                           FontSize="16"
                                           Margin="16,12" />
                                </Frame>
                            </VerticalStackLayout>

                            <!-- Confirm Password -->
                            <VerticalStackLayout Spacing="8">
                                <StackLayout Orientation="Horizontal" Spacing="8">
                                    <Label FontFamily="FontAwesome"
                                           Text="&#xf00c;"
                                           FontSize="14"
                                           TextColor="{StaticResource Success}"
                                           VerticalOptions="Center" />
                                    <Label Text="새 비밀번호 확인"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Gray700}"
                                           VerticalOptions="Center" />
                                </StackLayout>
                                <Frame BackgroundColor="{StaticResource Gray50}"
                                       BorderColor="{StaticResource Gray200}"
                                       CornerRadius="12"
                                       HasShadow="False"
                                       Padding="0">
                                    <Entry Text="{Binding ConfirmNewPassword}"
                                           Placeholder="새 비밀번호를 다시 입력하세요"
                                           IsPassword="True"
                                           FontSize="16"
                                           Margin="16,12" />
                                </Frame>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- Messages -->
                <!-- Error Message -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                       BackgroundColor="#FFEBEE"
                       BorderColor="#F44336"
                       CornerRadius="12"
                       Padding="20"
                       HasShadow="False">
                    <StackLayout Orientation="Horizontal" Spacing="16">
                        <Frame BackgroundColor="#F44336"
                               CornerRadius="20"
                               HeightRequest="40"
                               WidthRequest="40"
                               HasShadow="False"
                               Padding="0">
                            <Label FontFamily="FontAwesome"
                                   Text="&#xf071;"
                                   FontSize="18"
                                   TextColor="White"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                        </Frame>
                        <Label Text="{Binding ErrorMessage}"
                               TextColor="#C62828"
                               VerticalOptions="Center"
                               HorizontalOptions="FillAndExpand"
                               LineBreakMode="WordWrap"
                               FontSize="16" />
                    </StackLayout>
                </Frame>

                <!-- Success Message -->
                <Frame IsVisible="{Binding SuccessMessage, Converter={StaticResource StringToBoolConverter}}"
                       BackgroundColor="#E8F5E8"
                       BorderColor="#4CAF50"
                       CornerRadius="12"
                       Padding="20"
                       HasShadow="False">
                    <StackLayout Orientation="Horizontal" Spacing="16">
                        <Frame BackgroundColor="#4CAF50"
                               CornerRadius="20"
                               HeightRequest="40"
                               WidthRequest="40"
                               HasShadow="False"
                               Padding="0">
                            <Label FontFamily="FontAwesome"
                                   Text="&#xf00c;"
                                   FontSize="18"
                                   TextColor="White"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                        </Frame>
                        <Label Text="{Binding SuccessMessage}"
                               TextColor="#2E7D32"
                               VerticalOptions="Center"
                               HorizontalOptions="FillAndExpand"
                               LineBreakMode="WordWrap"
                               FontSize="16" />
                    </StackLayout>
                </Frame>

                <!-- Loading Indicator for Updates -->
                <Frame IsVisible="{Binding IsBusy}"
                       BackgroundColor="White"
                       CornerRadius="12"
                       HasShadow="True"
                       Padding="20">
                    <StackLayout Orientation="Horizontal" Spacing="16" HorizontalOptions="Center">
                        <ActivityIndicator IsRunning="{Binding IsBusy}"
                                         Color="{StaticResource Primary}"
                                         Scale="1.2" />
                        <Label Text="업데이트 중..."
                               VerticalOptions="Center"
                               FontSize="16"
                               TextColor="{StaticResource Gray600}" />
                    </StackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Update Button -->
        <Button Grid.Row="1"
                Text="프로필 업데이트"
                Command="{Binding UpdateProfileCommand}"
                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                FontAttributes="Bold"
                CornerRadius="12"
                HeightRequest="48"
                Margin="0,16,0,0">
            <Button.ImageSource>
                <FontImageSource FontFamily="FontAwesome" 
                    Glyph="&#xf2f1;" 
                    Size="16" 
                    Color="White" />
            </Button.ImageSource>
        </Button>
    </Grid>
</ContentPage>