<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="BikeHistory.Mobile.Views.Auth.ProfilePage"
             xmlns:viewmodel="clr-namespace:BikeHistory.Mobile.ViewModels"
             x:DataType="viewmodel:ProfileViewModel"
             Title="내 프로필">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="로그아웃" 
                     Command="{Binding LogoutCommand}" 
                     IconImageSource="logout.png" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*,Auto" 
          Padding="20">

        <ActivityIndicator Grid.Row="0"
                          IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          VerticalOptions="Center"
                          HorizontalOptions="Center" />

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="15">
                <VerticalStackLayout HorizontalOptions="Center"
                                    Margin="0,20,0,30">
                    <Image Source="profile_icon.png"
                          HeightRequest="100"
                          WidthRequest="100"
                          HorizontalOptions="Center" />
                    
                    <Label Text="{Binding Email}"
                          FontSize="18"
                          HorizontalOptions="Center"
                          Margin="0,10,0,0" />
                    
                    <HorizontalStackLayout HorizontalOptions="Center" 
                                         Spacing="5"
                                         Margin="0,10,0,0">
                        <Label Text="권한: " />
                        <CollectionView ItemsSource="{Binding Roles}"
                                      HeightRequest="20"
                                      WidthRequest="100"
                                      HorizontalOptions="Center">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Horizontal"
                                                 ItemSpacing="5" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Label Text="{Binding}"
                                         TextColor="DarkBlue"
                                         FontAttributes="Bold" />
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <Label Text="기본 정보"
                      FontSize="18"
                      FontAttributes="Bold"
                      Margin="0,10,0,10" />

                <Frame BorderColor="LightGray"
                      Padding="15"
                      Margin="0,0,0,20">
                    <VerticalStackLayout Spacing="15">
                        <!-- 이름 -->
                        <Label Text="이름"
                             FontAttributes="Bold" />
                        <Entry Text="{Binding FirstName}"
                             Placeholder="이름을 입력하세요" />

                        <!-- 성 -->
                        <Label Text="성"
                             FontAttributes="Bold" />
                        <Entry Text="{Binding LastName}"
                             Placeholder="성을 입력하세요" />
                    </VerticalStackLayout>
                </Frame>

                <Button Text="비밀번호 변경"
                      Command="{Binding TogglePasswordChangeCommand}"
                      Style="{StaticResource TextButton}"
                      HorizontalOptions="Start" />

                <Frame BorderColor="LightGray"
                      Padding="15"
                      Margin="0,0,0,20"
                      IsVisible="{Binding IsPasswordChangeVisible}">
                    <VerticalStackLayout Spacing="15">
                        <!-- 현재 비밀번호 -->
                        <Label Text="현재 비밀번호"
                             FontAttributes="Bold" />
                        <Entry Text="{Binding CurrentPassword}"
                             Placeholder="현재 비밀번호를 입력하세요"
                             IsPassword="True" />

                        <!-- 새 비밀번호 -->
                        <Label Text="새 비밀번호"
                             FontAttributes="Bold" />
                        <Entry Text="{Binding NewPassword}"
                             Placeholder="새 비밀번호를 입력하세요"
                             IsPassword="True" />

                        <!-- 새 비밀번호 확인 -->
                        <Label Text="새 비밀번호 확인"
                             FontAttributes="Bold" />
                        <Entry Text="{Binding ConfirmNewPassword}"
                             Placeholder="새 비밀번호를 다시 입력하세요"
                             IsPassword="True" />
                    </VerticalStackLayout>
                </Frame>

                <!-- 오류/성공 메시지 -->
                <Label Text="{Binding ErrorMessage}"
                     TextColor="Red"
                     IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                     HorizontalOptions="Center"
                     Margin="0,10,0,0" />

                <Label Text="{Binding SuccessMessage}"
                     TextColor="Green"
                     IsVisible="{Binding SuccessMessage, Converter={StaticResource StringToBoolConverter}}"
                     HorizontalOptions="Center"
                     Margin="0,10,0,0" />

                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                 IsVisible="{Binding IsBusy}"
                                 HorizontalOptions="Center"
                                 Margin="0,10,0,0" />
            </VerticalStackLayout>
        </ScrollView>

        <Button Grid.Row="2"
              Text="프로필 업데이트"
              Command="{Binding UpdateProfileCommand}"
              IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}"
              Margin="0,10,0,0" />
    </Grid>
</ContentPage>